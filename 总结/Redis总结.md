# Redis总结

## 一.缓存

### 1.缓存是什么

高速存储器

### 2.缓存的好处

使用缓存可以避免访问数据库，节省数据库服务器的资源；

性能更快，缓存属于内存级的服务器，而且DB会涉及到更多的业务逻辑和磁盘IO操作，所以缓存性能更高。

3.常见缓存使用

本地缓存的常见使用：SpringCache,MyBaits的缓存

分布式缓存的常见使用：Redis和Memcached

### 3.本地缓存SpringCache使用及实现原理

使用步骤：

开启缓存，操作缓存，调用缓存。

在Spring项目的启动类上+@EnableCaching  表示开启缓存

#### （1）添加缓存

之后在需要操作的方法上（Service层）添加@Cacheable(cacheNames=''person" key="#id"),

其中cacheNames为需要缓存对象的名称，key为方法参数，之后通过传递的参数在缓存中查找结果。

#### （2）更新缓存

@CachePut(cacheNames="person"， key="#id")

#### （3）删除缓存

@CacheEvict(cacheNames="person", key="#id")



实现原理：

Map实现



## 二.Redis和Memcached的区别

缓存方式不同：memcache把数据全部缓存在内存中，断电后会挂掉，数据不能超过内存大小；Redis有部分在硬盘上，这样可以保证数据的持久性。

数据类型支持：memcache对数据类型支持相对简单；Redis有复杂的数据类型。

存储值大小不同：Redis最大可以达512mb;memcache只有1mb。



## 三.Redis数据类型和使用

### 1.五大基本数据类型

String-字符串类型，Hash-字典类型，List列表类型，Set-集合类型，ZSet-有序集合类型。前两个常用

#### （1）String-字符串类型

以key-value形式进行存储，根据key获取value，实际使用较多

set k1 v1 添加数据

get k1 查询数据

strlen k1  查询字符串的长度

ex(expires)参数设置字符串过期时间：set k1 v1 ex 1000 设置1000s后过期

使用场景：

存放用户（登录）信息

存放文章详情和列表信息

存放和累计网页的统计信息

#### （2）Hash-字典类型

key和一个哈希表关联，相当于Map<String,Map<String, String>>结构。

#### （3）List-列表类型

使用链表结构存储的有序结构，插入时会按照先后顺序来插入，及插入和删除的时间复杂度为O(1)，查询时间复杂度O(n)

lpush list 1 2 3 添加三个数据

lpop list 获取并删除列表的第一个元素

使用场景：

1.消息队列

列表类型可以使用rpush实现先进先出功能，同时可以使用lpop轻松弹出（查询并删除）第一个元素。

2.文章列表

对于博客站点来说，当用户和文章都越来越多时，为了加快程序的响应速度，我们可以把用户自己的文章存入到list中，因为list是有序的结构，所以这样又可以完美的实现分页功能，从而加快了程序的响应速度。

#### （4）Set-集合类型

无序并唯一的键值集合。

sadd myset v1 v2 v3 添加数据

smembers myset 查询集合中所有元素

使用场景：

微博中关注我的人和我关注的人，使用集合存储，保证不重复。

中奖人信息，可以保证一个人不会重复中奖

集合和列表的区别：

列表list可以存储重复元素，集合set只能存储非重复元素。

列表是按照元素的先后顺序存储元素的，而集合则是无序方式存储元素的。

#### （5）ZSet-有序集合

比集合类型多了一个排序属性score，对于有序集合ZSet来说，每个元素由两个值构成，一个是元素值，一个是排序值，有序集合的存储元素也不能重复，分数值可以重复。

zadd zset1 3 golong 4 sql 1 redis 添加数据

zrange zset 0 -1 查询所有数据

使用场景：

学生成绩排名

粉丝列表：根据关注的先后时间排序



## 四.持久化

### 1.概念

持久化：将数据从内存保存到磁盘的过程

目的：防止数据丢失

### 2.Reids持久化的3种方式

#### （1）快照方式（RDB）

将某一时刻的内存数据，以二进制的范式写入磁盘

优点：内容为二进制，占用内存小，适合做备份文件；对灾难恢复非常有用，由于文件紧凑，所有更快地传输到远程服务器进行Redis服务恢复；可以提高Redis的运行速度，每次持久化时，Redis主进程都会fork一个子进程进行数据化持久到硬盘上，Redis主进程不会执行磁盘I/O；与AOF相比，RDB文件可以更快地重启。

缺点：只能保存某个时刻的数据，如果中途Redis服务终止，则会丢失一段时间内的数据；如果数据集过大，fork可能很耗时，如果数据集很大且CPU性能不佳，可能导致Redis定制为客户端服务几毫秒或1秒。

#### （2）文件追加方式（AOF）

记录所有的操作命令，并以文本追加的形式追加到文件中。

优点：持久化数据保存地更完整，提供了三种保存策略：每次操作保存，每秒保存一次，系统控制（整体过程不可控）；文件易于理解。

缺点：文件大小比RDB大；Redis负载较高时，没有RDB性能好；没有RDB健壮（一个是将执行命令追加到文件中，一个是将Redis数据进行持久化）

#### （3）混合持久化方式

Redis4.0后新增的方式，结合了RDB和AOF的优点；在写入时，先把当前数据以RDB的方式写入，再将后续的操作命令以AOF的格式存入文件，既保证Redis重启时的速度，又降低数据丢失的风险。

优点：结合了RDB和AOF，使Redis可以更快地启动，也可以降低大量数据丢失的风险。

缺点：AOF中添加了RDB，文件可读性降低；兼容性差，只支持Redis4.0后。

3.持久化策略设置

在redis-cli命令中执行 config set aof-user-rdb-preamble yes 来开启混合持久化；使用config set appendonly yes 来开启AOF持久化策略；如果都没有默认为RDB。



## 五.缓存雪崩

### 1.什么是缓存雪崩

短时间内大量缓存同时过期，导致当量的请求直接查询数据库，从而对数据库造成巨大压力，严重时可能导致数据库宕机。

### 2.如何解决

#### （1）加锁排队

可以起到缓冲的作用，防止大量的请求同时操作数据库，缺点是增加了系统的响应时间，降低了系统的吞吐量，牺牲了一部分用户体验。

#### （2）随机化过期时间

在设置缓存是天啊及随机时间

#### （3）设置为永不过期（没必要）

#### （4）设置二级缓存

相当于再设置一层缓存如本地缓存，如果Redis缓存失效，就先查询本地缓存



## 六.缓存穿透

### 1.什么是缓存穿透

查询数据库和缓存都没有数据；没有查到不会将结果保存在缓存中，之后每次请求都会去查询数据库，可能会给数据库造成很大压力。

### 2.解决方式

缓存空结果，将每次从数据库查询的数据都保存到缓存中（将空结果保存到缓存中，可以将空结果的缓存时间设置的短一些）。



## 七.缓存击穿

### 1.什么是缓存击穿

某个热点缓存，在某一时刻恰好失效了，然后此时刚好有大量的并发请求，此时这些请求会给数据库造成巨大的压力，该情况就叫做缓存击穿

### 2.解决方案

#### （1）加锁排队

和缓存雪崩类似，都是在查询数据库时加锁排队，缓冲操作请求来减少服务器的压力。

#### （2）设置永不过期

对于某些热点缓存可以设置永不过期，这样就能保证缓存的稳定性（注意：在数据更改后要及时更新该热点缓存，避免造成查询结果误差）



## 八.定时任务

预计某个时间去执行某件事的行为称之为定时任务

Spring中使用方式：

1.在启动类加上@EnableScheduling 用来开启定时任务

2.自定义一个任务类，添加@Component或@Service注解，然后再任务方法上添加@Scheduled(cron="表达式")

启动了SpringBoot项目后，会自动执行Service里面的定时任务，无需手动触发。

例子： 0/2 * * * * ？ 表示每两秒执行任务

定时任务原理：

拦截所有@Scheduled方法，通过解析cron表达式确定下次执行的时间，开启线程执行，然后再以固定的频次去执行这些任务。

## 九.监控

可以监测生产环境的信息，如：

查询项目中目前的缓存信息；查询项目中的所有定时任务列表；查询项目中所有的beans；查询项目中的所有mapping；查询项目运行信息env，查看日志，停止SpringBoot项目（post方式）。

使用步骤：添加actuator框架（pom.xml中添加），配置监控（在properties文件中配置），查看监控（url查看）。

## 十.缓存预热

1.什么是缓存预热

不是一个问题，而是使用缓存时的一个优化方案，可以提高前台用户的使用体验。

缓存预热指的是在系统启动的时候，先把查询结果预存到缓存中，以便用户后面查询时可以直接从缓存中读取，来节约用户的等待时间。

2.实现思路

把需要缓存的方法写在系统初始化的方法中，系统在启动的时候会自动的加载数据并缓存数据；

把需要缓存的方法挂载到某个页面或后端接口上，手动出发缓存预热；

设置定时任务，定时自动进行缓存预热

九.Redis集群（了解）

单机Redis性能无法满足需求，所以需要将单机服务扩展到多机服务，Redis多机服务主要包含以下3个内容：Redis主从同步，Redis哨兵模式，Redis集群服务（3.0新增功能）

（1）主从同步（主从复制）

将主要存储数据的节点为主节点，其他通过复制主节点数据的副本节点为从节点

<img src="C:\Users\hasee\AppData\Roaming\Typora\typora-user-images\image-20220803172229913.png" alt="image-20220803172229913" style="zoom:50%;" />

（2）哨兵模式

（3）集群服务
